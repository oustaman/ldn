<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>London Location Ethnography Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
        }
        
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        header {
            background-color: #1d3557;
            color: white;
            padding: 10px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        h1 {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }
        
        header p {
            font-size: 0.8rem;
        }
        
        #map {
            flex: 1;
            z-index: 0;
        }
        #a {
          color: white;
        }
        
        .controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #1d3557;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            cursor: pointer;
            font-size: 24px;
        }
        
        .panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            border-radius: 15px 15px 0 0;
            padding: 20px 15px;
        }
        
        .panel.active {
            transform: translateY(0);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .panel-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #1d3557;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .search-container {
            margin-bottom: 15px;
        }
        
        #search {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .stats {
            background-color: #457b9d;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }
        
        .filter-section {
            margin-bottom: 20px;
        }
        
        .filter-section h3 {
            color: #1d3557;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .filter-btn {
            padding: 8px 12px;
            background-color: #457b9d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            flex: 1;
            font-size: 0.9rem;
        }
        
        .tube-filter {
            padding: 8px 0;
            display: flex;
            align-items: center;
        }
        
        .tube-filter input {
            margin-right: 10px;
            width: 20px;
            height: 20px;
        }
        
        .tube-line {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        /* Tube line colors */
        .tube-line-bakerloo { background-color: #B36305; }
        .tube-line-central { background-color: #E32017; }
        .tube-line-circle { background-color: #FFD300; }
        .tube-line-district { background-color: #00782A; }
        .tube-line-hammersmith { background-color: #F3A9BB; }
        .tube-line-jubilee { background-color: #A0A5A9; }
        .tube-line-metropolitan { background-color: #9B0056; }
        .tube-line-northern { background-color: #000000; }
        .tube-line-piccadilly { background-color: #003688; }
        .tube-line-victoria { background-color: #0098D4; }
        .tube-line-waterloo { background-color: #95CDBA; }
        .tube-line-elizabeth { background-color: #6950a1; }
        .tube-line-dlr { background-color: #00A4A7; }
        .tube-line-overground { background-color: #EE7C0E; }
        .tube-line-multiple { background-color: #666666; }
        
        .marker-pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            position: absolute;
            left: 50%;
            top: 50%;
            margin: -15px 0 0 -15px;
        }
        
        .marker-pin::after {
            content: '';
            width: 24px;
            height: 24px;
            margin: 3px 0 0 3px;
            background: #fff;
            position: absolute;
            border-radius: 50%;
        }
        
        .marker-pin-completed {
            position: relative;
        }
        
        .marker-pin-completed::before {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            font-size: 14px;
            font-weight: bold;
            color: green;
            z-index: 10;
        }
        
        .leaflet-popup-content {
            max-width: 280px;
            min-width: 180px;
            font-size: 0.9rem;
        }
        
        .popup-content h3 {
            margin-bottom: 8px;
            color: #1d3557;
            font-size: 1rem;
        }
        
        .popup-detail {
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        
        .popup-label {
            font-weight: bold;
            color: #1d3557;
            margin-right: 5px;
        }
        
        .tube-stop-info {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        
        .completed-checkbox {
            display: flex;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        
        .completed-checkbox input {
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }
        
        .completed-checkbox label {
            font-weight: bold;
            color: #1d3557;
        }
        
        .reset-btn {
            font-size: 0.8rem;
            color: #999;
            background: none;
            border: none;
            text-decoration: underline;
            cursor: pointer;
            text-align: right;
            display: block;
            margin-left: auto;
            padding: 5px;
            margin-top: -5px;
            margin-bottom: 10px;
        }
        
        .reset-btn:hover {
            color: #E32017;
        }
        
        .completion-filter {
            display: flex;
            align-items: center;
            background-color: #f0f8ff;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .completion-filter input {
            margin-right: 8px;
            width: 20px;
            height: 20px;
        }
        
        @media (min-width: 768px) {
            h1 {
                font-size: 1.5rem;
            }
            
            header p {
                font-size: 1rem;
            }
            
            .panel {
                left: auto;
                width: 350px;
                top: 0;
                bottom: 0;
                transform: translateX(100%);
                max-height: 100vh;
                border-radius: 0;
            }
            
            .panel.active {
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <header>
    </header>
    
    <div id="map"></div>
    
    <div class="controls">
        <button id="toggleFilters" class="btn" aria-label="Toggle filters">
            ‚ò∞
        </button>
        <button id="locateNearby" class="btn" aria-label="Show nearby locations">
            üìç
        </button>
    </div>
    
    <div id="filterPanel" class="panel">
        <div class="panel-header">
            <h2 class="panel-title">Filters</h2>
            <button class="close-btn" id="closePanel">&times;</button>
        </div>
        
        <div class="search-container">
            <input type="text" id="search" placeholder="Search locations...">
        </div>
        
        <div class="stats">
            <span>Total Locations: <span id="locationCount">0</span></span>
        </div>
        
        <div class="completion-filter">
            <input type="checkbox" id="hideCompleted" value="1">
            <label for="hideCompleted">Hide completed locations</label>
        </div>
        
        <button id="resetCompletions" class="reset-btn">Reset all completed items</button>
        
        <div class="filter-section">
            <h3>Filter by Neighborhood</h3>
            <div class="filter-buttons">
                <button id="selectAllNeighborhoods" class="filter-btn">Select All</button>
                <button id="clearAllNeighborhoods" class="filter-btn">Clear All</button>
            </div>
            <div id="neighborhoodFilters"></div>
        </div>
        
        <div class="filter-section">
            <h3>Filter by Tube Line</h3>
            <div class="filter-buttons">
                <button id="selectAllTubeLines" class="filter-btn">Select All</button>
                <button id="clearAllTubeLines" class="filter-btn">Clear All</button>
            </div>
            <div id="tubeLineFilters"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Get completed locations from localStorage
            let completedLocations = getCompletedLocations();
            
            // Location data (excerpt - using the first 10 for testing)


            const locations = [
    // Regent Street Area
    { id: 'regent-street-wide', name: 'Regent Street (Wide)', neighborhood: 'Regent Street', tubeStop: 'Oxford Circus', tubeLine: 'central', 
      coordinates: [51.5144, -0.1400],
      userBehavior: "Eye is drawn along the curve of the street.", 
      navigationAids: "Architectural curve.", 
      concept: "Regent Street's curved pathway creates progressive disclosure, revealing destinations gradually as visitors move through the space." },
      
    { id: 'north-face-apple', name: 'The North Face/Apple (Close-up)', neighborhood: 'Regent Street', tubeStop: 'Oxford Circus', tubeLine: 'central',
      coordinates: [51.5147, -0.1415],
      userBehavior: "Users approach the store entrance.", 
      navigationAids: "Prominent store entrance, branding.", 
      concept: "Flagship stores function as 'call-to-action' elements within Regent Street's broader navigational structure." },
      
    { id: 'regent-street-user', name: 'Regent Street (User Behavior)', neighborhood: 'Regent Street', tubeStop: 'Oxford Circus', tubeLine: 'central',
      coordinates: [51.5139, -0.1405],
      userBehavior: "People consulting maps or phones.", 
      navigationAids: "Maps, phones (due to navigation breakdown).", 
      concept: "Navigation breakdowns in physical spaces mirror common patterns in digital interfaces, as users pause to reorient themselves." },
      
    { id: 'regent-street-arch', name: 'Regent Street (Architectural)', neighborhood: 'Regent Street', tubeStop: 'Oxford Circus', tubeLine: 'central',
      coordinates: [51.5132, -0.1408],
      userBehavior: "Visitors navigate within a unified architectural framework.", 
      navigationAids: "Curved street, unified architecture, brand signs.", 
      concept: "Regent Street's architectural uniformity creates a design system within which brands express identity‚Äîparalleling digital UI frameworks that maintain consistency while enabling customization." },
      
    { id: 'apple-store-entrance', name: 'Apple Store Entrance (Medium)', neighborhood: 'Regent Street', tubeStop: 'Oxford Circus', tubeLine: 'central',
      coordinates: [51.5142, -0.1420],
      userBehavior: "Users enter with minimal hesitation due to transparent design.", 
      navigationAids: "Transparent glass facade, open entrance.", 
      concept: "Apple's transparent threshold design reduces psychological barriers to entry‚Äîa principle directly applicable to digital conversion optimization." },
    
    // Neal's Yard Area
    { id: 'neals-yard-entrance', name: 'Neal\'s Yard Entrance (Close-up)', neighborhood: 'Covent Garden', tubeStop: 'Covent Garden', tubeLine: 'piccadilly',
      coordinates: [51.5135, -0.1268],
      userBehavior: "Users might walk past initially, requiring exploration to locate.", 
      navigationAids: "Narrow, easily-missed entrance.", 
      concept: "Neal's Yard's concealed entrances exemplify discovery-based navigation, requiring prior knowledge or exploration to locate." },
      
    { id: 'neals-yard-contrast', name: 'Neal\'s Yard Contrast Shot', neighborhood: 'Covent Garden', tubeStop: 'Covent Garden', tubeLine: 'piccadilly',
      coordinates: [51.5137, -0.1267],
      userBehavior: "Users experience a transition from mundane exterior to vibrant interior.", 
      navigationAids: "Contrast between entrance and courtyard.", 
      concept: "The contrast between Neal's Yard's mundane entrances and vibrant interior creates a memorable discovery experience that reinforces spatial memory." },
    
    // Battersea Park Area
    { id: 'battersea-park-aerial', name: 'Battersea Park (Aerial/Map)', neighborhood: 'Battersea', tubeStop: 'Battersea Park', tubeLine: 'overground',
      coordinates: [51.4790, -0.1535],
      userBehavior: "Users orient themselves based on activity zones and connecting pathways.", 
      navigationAids: "Overall park layout, pathways, different zones.", 
      concept: "Battersea Park's hub-and-spoke layout creates a zonal navigation system where users orient by activity areas rather than sequential paths." },
      
    { id: 'battersea-park-decision', name: 'Battersea Park (Decision Point)', neighborhood: 'Battersea', tubeStop: 'Battersea Park', tubeLine: 'overground',
      coordinates: [51.4808, -0.1548],
      userBehavior: "Users look at signage or visual cues before choosing a path at an intersection.", 
      navigationAids: "Signage, visual cues.", 
      concept: "Decision points in physical navigation provide insights for designing effective choice architecture in digital interfaces." },
      
    { id: 'battersea-park-user', name: 'Battersea Park (User Distribution)', neighborhood: 'Battersea', tubeStop: 'Battersea Park', tubeLine: 'overground',
      coordinates: [51.4785, -0.1512],
      userBehavior: "Different user groups naturally gather in their preferred activity zones.", 
      navigationAids: "Natural grouping based on activities.", 
      concept: "Different user segments naturally gravitate toward their preferred zones, demonstrating intuitive activity-based wayfinding." },
      
    { id: 'battersea-park-zoo', name: 'Battersea Park Children\'s Zoo Entrance', neighborhood: 'Battersea', tubeStop: 'Battersea Park', tubeLine: 'overground',
      coordinates: [51.4800, -0.1552],
      userBehavior: "Users transition from the general park environment to the specific visual language of the zoo.", 
      navigationAids: "Entrance design, signage at child height.", 
      concept: "Threshold design: The zoo entrance creates a narrowing of focus and introduction of the zoo's visual language‚Äîsimilar to an effective digital onboarding sequence." },
      
    { id: 'zoo-exhibit-panel', name: 'Zoo Exhibit Information Panel', neighborhood: 'Battersea', tubeStop: 'Battersea Park', tubeLine: 'overground',
      coordinates: [51.4798, -0.1556],
      userBehavior: "Child interacts with information displayed at their height level.", 
      navigationAids: "Height positioning, potentially multi-sensory elements.", 
      concept: "Information architecture in physical form: Content hierarchy designed for primary users (children) while remaining accessible to all." },
      
    { id: 'zoo-feeding-time', name: 'Zoo Feeding Time Demonstration', neighborhood: 'Battersea', tubeStop: 'Battersea Park', tubeLine: 'overground',
      coordinates: [51.4795, -0.1558],
      userBehavior: "Visitors gather for a scheduled event, and the space accommodates the crowd.", 
      navigationAids: "Timed event, spatial organization.", 
      concept: "Timed engagement points create rhythm and structure in physical experiences, similar to well-designed notification systems." },
      
    { id: 'battersea-power-station', name: 'Battersea Power Station (Contrast)', neighborhood: 'Battersea', tubeStop: 'Battersea Power Station', tubeLine: 'northern',
      coordinates: [51.4817, -0.1440],
      userBehavior: "Visitors observe the blend of historic structure and modern functionality.", 
      navigationAids: "Historic elements, modern additions.", 
      concept: "Battersea Power Station's blend of historic structure and modern functionality mirrors the challenge of modernizing legacy digital systems." },
    
    // Hyde Park
    { id: 'hyde-park-serpentine', name: 'Hyde Park Serpentine Water Edge', neighborhood: 'Hyde Park', tubeStop: 'Hyde Park Corner', tubeLine: 'piccadilly',
      coordinates: [51.5053, -0.1652],
      userBehavior: "Users can choose their level of interaction with the water based on access points.", 
      navigationAids: "Gradual water access points, safety features.", 
      concept: "Progressive disclosure in physical space: Users can self-select their level of engagement with the water." },
    
    // Olympic Park
    { id: 'olympic-park-wayfinding', name: 'Olympic Park Wayfinding Junction', neighborhood: 'Olympic Park', tubeStop: 'Stratford', tubeLine: 'central',
      coordinates: [51.5431, -0.0140],
      userBehavior: "Users make choices at a junction with multiple path options, potentially using landmarks and signage.", 
      navigationAids: "Multiple path options, visible landmarks, signage.", 
      concept: "Decision architecture: How physical spaces guide choices through environmental cues rather than explicit instructions." },
      
    { id: 'olympic-park-transitional', name: 'Olympic Park (Transitional)', neighborhood: 'Olympic Park', tubeStop: 'Stratford', tubeLine: 'central',
      coordinates: [51.5425, -0.0133],
      userBehavior: "Visitors experience multi-purpose spaces that reconfigure based on crowd size and contextual needs.", 
      navigationAids: "Adaptable physical spaces.", 
      concept: "Olympic Park's adaptable spaces mirror responsive digital design, reconfiguring based on contextual needs." },
      
    { id: 'olympic-park-wayfinding2', name: 'Olympic Park (Wayfinding)', neighborhood: 'Olympic Park', tubeStop: 'Stratford', tubeLine: 'central',
      coordinates: [51.5416, -0.0120],
      userBehavior: "Users encounter strategically placed wayfinding at decision points, reducing cognitive load.", 
      navigationAids: "Wayfinding elements at decision points.", 
      concept: "Strategic placement of wayfinding elements at decision points reduces cognitive load‚Äîa principle equally valuable in digital interface design." },
    
    // Children's Playground
    { id: 'childrens-playground', name: 'Children\'s Playground Equipment', neighborhood: 'Various Parks', tubeStop: 'Various', tubeLine: 'multiple',
      coordinates: [51.5114, -0.1587],
      userBehavior: "Children intuitively understand and use play elements without explicit instruction.", 
      navigationAids: "Affordances of the equipment.", 
      concept: "Physical affordances telegraph function without instruction‚Äîthe ultimate goal of intuitive UI design." },
    
    // Hounslow
    { id: 'hounslow-high-wide', name: 'Hounslow High Street (Wide)', neighborhood: 'Hounslow', tubeStop: 'Hounslow Central', tubeLine: 'piccadilly',
      coordinates: [51.4705, -0.3666],
      userBehavior: "Pedestrians naturally follow the curved architecture of the plaza.", 
      navigationAids: "Semi-circular plaza architecture.", 
      concept: "Curved architecture creates implicit pathways‚Äîphysical manifestations of digital default settings." },
      
    { id: 'hounslow-high-transition', name: 'Hounslow High Street (Transition)', neighborhood: 'Hounslow', tubeStop: 'Hounslow Central', tubeLine: 'piccadilly',
      coordinates: [51.4713, -0.3670],
      userBehavior: "Different paving materials subtly indicate different functional zones.", 
      navigationAids: "Changes in paving materials.", 
      concept: "Material changes subtly communicate functional zones without explicit signage‚Äîthe urban equivalent of well-designed UI affordances." },
      
    { id: 'hounslow-high-cultural', name: 'Hounslow High Street (Cultural)', neighborhood: 'Hounslow', tubeStop: 'Hounslow Central', tubeLine: 'piccadilly',
      coordinates: [51.4717, -0.3653],
      userBehavior: "Architectural details on building facades reflect multicultural influences.", 
      navigationAids: "Architectural details with cultural references.", 
      concept: "Inclusive defaults acknowledge diverse user populations through cultural references." },
    
    // Westminster Bridge
    { id: 'westminster-bridge-benches', name: 'Westminster Bridge (Multi-height Benches)', neighborhood: 'Westminster', tubeStop: 'Westminster', tubeLine: 'jubilee',
      coordinates: [51.5006, -0.1242],
      userBehavior: "Diverse park visitors use benches designed for different body types and ages.", 
      navigationAids: "Multi-height interactive benches.", 
      concept: "Elephant Park's seating designs accommodate different body types, ages, and usage patterns‚Äîdemonstrating how thoughtful defaults can create inclusive experiences without calling attention to accommodations." },
      
    { id: 'westminster-bridge-traffic', name: 'Westminster Bridge (Traffic Flow)', neighborhood: 'Westminster', tubeStop: 'Westminster', tubeLine: 'jubilee',
      coordinates: [51.5008, -0.1230],
      userBehavior: "Pedestrians, cyclists, and vehicles navigate the bridge, with tourists causing congestion.", 
      navigationAids: "Wide pavements, separated lanes, safety barriers.", 
      concept: "Competing priorities: Westminster Bridge must simultaneously serve tourists, commuters, and vehicles while maintaining safety for all." },
      
    { id: 'westminster-bridge-barriers', name: 'Westminster Bridge (Safety Barriers)', neighborhood: 'Westminster', tubeStop: 'Westminster', tubeLine: 'jubilee',
      coordinates: [51.5010, -0.1225],
      userBehavior: "Safety barriers are integrated with the historic structure, impacting the user experience.", 
      navigationAids: "Safety barriers.", 
      concept: "Necessary friction: safety features balanced with heritage preservation and user experience." },
      
    { id: 'westminster-bridge-congestion', name: 'Westminster Bridge (Tourist Congestion)', neighborhood: 'Westminster', tubeStop: 'Westminster', tubeLine: 'jubilee',
      coordinates: [51.5013, -0.1220],
      userBehavior: "Tourists stop for photos, creating unplanned congestion points.", 
      navigationAids: "Iconic views.", 
      concept: "Unplanned use cases: designers must anticipate how users will actually behave, not just how they should behave." },
      
    { id: 'westminster-bridge-paths', name: 'Westminster Bridge (Segregated Paths)', neighborhood: 'Westminster', tubeStop: 'Westminster', tubeLine: 'jubilee',
      coordinates: [51.5015, -0.1235],
      userBehavior: "Cyclists and pedestrians use physically separated lanes based on their mode of transport.", 
      navigationAids: "Separated cycle paths and pedestrian areas.", 
      concept: "Segregated paths on Westminster Bridge create 'user lanes' based on intent and speed‚Äîa physical manifestation of digital user journey separation." },
      
    { id: 'westminster-bridge-crossing', name: 'Westminster Bridge (Zebra Crossing)', neighborhood: 'Westminster', tubeStop: 'Westminster', tubeLine: 'jubilee',
      coordinates: [51.5017, -0.1240],
      userBehavior: "Pedestrians consciously cross the cycle lane at a zebra crossing near a bus stop bypass.", 
      navigationAids: "Zebra crossing.", 
      concept: "The zebra crossing functions as a modal dialog‚Äîa deliberate friction point requiring conscious action to ensure safety." },
      
    { id: 'westminster-bridge-goals', name: 'Westminster Bridge (Competing Goals)', neighborhood: 'Westminster', tubeStop: 'Westminster', tubeLine: 'jubilee',
      coordinates: [51.5014, -0.1238],
      userBehavior: "Tourists stop for photos while commuters navigate around them in the shared space.", 
      navigationAids: "Shared environment, different user behaviors.", 
      concept: "Multiple user types with competing goals share the same environment‚Äîa common challenge in both physical and digital spaces." },
    
    // Greenwich Foot Tunnel
    { id: 'greenwich-foot-tunnel-wide', name: 'Greenwich Foot Tunnel (Wide)', neighborhood: 'Greenwich', tubeStop: 'Cutty Sark', tubeLine: 'dlr',
      coordinates: [51.4834, -0.0095],
      userBehavior: "Users choose between stairs and a lift based on signage and their needs.", 
      navigationAids: "Staircase, lift entrances, directional signage.", 
      concept: "Decision points at the Greenwich Foot Tunnel entrance: heritage preservation meets accessibility requirements, creating divergent user journeys." },
      
    { id: 'greenwich-foot-tunnel-lift', name: 'Greenwich Foot Tunnel (Lift Controls)', neighborhood: 'Greenwich', tubeStop: 'Cutty Sark', tubeLine: 'dlr',
      coordinates: [51.4836, -0.0097],
      userBehavior: "Users interact with modern lift controls added to the historic structure.", 
      navigationAids: "Lift controls, information signage.", 
      concept: "Retrofitted accessibility: modern interface elements added to century-old infrastructure highlight the challenges of adapting legacy systems." },
      
    { id: 'greenwich-foot-tunnel-user', name: 'Greenwich Foot Tunnel (User Behavior)', neighborhood: 'Greenwich', tubeStop: 'Cutty Sark', tubeLine: 'dlr',
      coordinates: [51.4833, -0.0092],
      userBehavior: "Some users wait for the lift while others use the stairs freely, leading to different experiences.", 
      navigationAids: "Stairs, lift, user choices.", 
      concept: "Divergent experiences: some users navigate the tunnel efficiently while others wait for accessibility accommodations." },
      
    { id: 'greenwich-foot-tunnel-rotunda', name: 'Greenwich Foot Tunnel (Exterior Rotunda)', neighborhood: 'Greenwich', tubeStop: 'Cutty Sark', tubeLine: 'dlr',
      coordinates: [51.4830, -0.0094],
      userBehavior: "The historic red-brick rotunda entrance with Thames backdrop establishes heritage context.", 
      navigationAids: "Red-brick rotunda, Thames background.", 
      concept: "The 1902 Greenwich Foot Tunnel entrance, whose heritage status constrains modernization efforts." },
      
    { id: 'greenwich-foot-tunnel-status', name: 'Greenwich Foot Tunnel (Lift Status)', neighborhood: 'Greenwich', tubeStop: 'Cutty Sark', tubeLine: 'dlr',
      coordinates: [51.4831, -0.0093],
      userBehavior: "Digital display shows the status of the lift in the historic structure.", 
      navigationAids: "Digital lift status display.", 
      concept: "Digital monitoring adds a layer of usefulness to the historic structure without altering it‚Äîa common approach in legacy interfaces." },
      
    { id: 'greenwich-foot-tunnel-phones', name: 'Greenwich Foot Tunnel (Checking Phones)', neighborhood: 'Greenwich', tubeStop: 'Cutty Sark', tubeLine: 'dlr',
      coordinates: [51.4835, -0.0094],
      userBehavior: "Visitors check lift status on their phones before committing to the journey due to unreliability.", 
      navigationAids: "Phones, lack of reliable physical information.", 
      concept: "Users develop workarounds when heritage systems prove unreliable‚Äîchecking status before committing to the journey." },
      
    { id: 'cutty-sark-pier', name: 'Cutty Sark Pier (Modal Transition)', neighborhood: 'Greenwich', tubeStop: 'Cutty Sark', tubeLine: 'dlr',
      coordinates: [51.4825, -0.0090],
      userBehavior: "Signage guides passengers transitioning between ferry and land transport systems.", 
      navigationAids: "Signage at system boundaries.", 
      concept: "Modal transition interface: Signage at system boundaries guides users between different transportation networks." },
    
    // Oxford Circus
    { id: 'oxford-circus-peak', name: 'Oxford Circus (Peak Hour)', neighborhood: 'Oxford Street', tubeStop: 'Oxford Circus', tubeLine: 'central',
      coordinates: [51.5152, -0.1410],
      userBehavior: "High pedestrian density maintains flow through clear pathways and signals.", 
      navigationAids: "Clear signage, multiple exit paths, visual cues.", 
      concept: "High-density environments require clear pathways and signals‚Äîwhether in physical or digital space." },
      
    { id: 'oxford-circus-signage', name: 'Oxford Circus (Signage)', neighborhood: 'Oxford Street', tubeStop: 'Oxford Circus', tubeLine: 'central',
      coordinates: [51.5154, -0.1414],
      userBehavior: "Clear directional signage and exit markings are crucial under pressure.", 
      navigationAids: "Underground exit signs, street signage.", 
      concept: "Clear signaling becomes increasingly important as user density increases‚Äîa principle true in both physical and digital environments." },
      
    { id: 'oxford-circus-user', name: 'Oxford Circus (User Behavior)', neighborhood: 'Oxford Street', tubeStop: 'Oxford Circus', tubeLine: 'central',
      coordinates: [51.5153, -0.1418],
      userBehavior: "People naturally form lanes and follow efficient patterns during crowded periods.", 
      navigationAids: "Natural pedestrian flow.", 
      concept: "Users naturally create efficient patterns when given appropriate environmental cues‚Äîgood design works with these natural tendencies." },
    
    // Southbank
    { id: 'southbank-centre-brutalist', name: 'Southbank Centre (Brutalist)', neighborhood: 'Southbank', tubeStop: 'Waterloo', tubeLine: 'jubilee',
      coordinates: [51.5066, -0.1164],
      userBehavior: "Brutalist architecture adapted with integrated ramps and lifts for accessibility.", 
      navigationAids: "Concrete structure, integrated ramps/lifts.", 
      concept: "The Southbank Centre's brutalist architecture has been adapted for accessibility without compromising its essential character." },
      
    { id: 'southbank-centre-signage', name: 'Southbank Centre (Signage)', neighborhood: 'Southbank', tubeStop: 'Waterloo', tubeLine: 'jubilee',
      coordinates: [51.5062, -0.1162],
      userBehavior: "Accessibility signage is designed to complement the brutalist aesthetic.", 
      navigationAids: "Accessibility signage matching the aesthetic.", 
      concept: "Accessibility signage designed to complement rather than conflict with the brutalist aesthetic‚Äîa model for integrated rather than appended solutions." },
      
    { id: 'southbank-centre-users', name: 'Southbank Centre (Diverse Users)', neighborhood: 'Southbank', tubeStop: 'Waterloo', tubeLine: 'jubilee',
      coordinates: [51.5064, -0.1160],
      userBehavior: "Users of different abilities successfully navigate and use the space.", 
      navigationAids: "Accessible design, diverse users.", 
      concept: "The result of successful integration: a heritage space that welcomes users of all abilities." },
      
    { id: 'southbank-river-walk', name: 'Southbank (River Walk)', neighborhood: 'Southbank', tubeStop: 'Waterloo', tubeLine: 'jubilee',
      coordinates: [51.5068, -0.1175],
      userBehavior: "Users navigate with the River Thames as a constant reference point.", 
      navigationAids: "River Thames.", 
      concept: "The River Thames provides a constant reference point along Southbank‚Äîsimilar to how persistent headers orient users in digital interfaces." },
    
    // Wembley
    { id: 'wembley-park-match', name: 'Wembley Park (Match Day)', neighborhood: 'Wembley', tubeStop: 'Wembley Park', tubeLine: 'metropolitan',
      coordinates: [51.5632, -0.2790],
      userBehavior: "Dense crowds selectively process wayfinding cues while navigating.", 
      navigationAids: "Multiple information touchpoints, dense crowds.", 
      concept: "Information filtering in action: Match day attendees at Wembley Park Station selectively process wayfinding cues while navigating through dense crowds‚Äîa physical manifestation of the same cognitive processes users employ when landing on feature-rich digital interfaces." },
      
    { id: 'wembley-temporary-signage', name: 'Wembley Temporary Signage', neighborhood: 'Wembley', tubeStop: 'Wembley Park', tubeLine: 'metropolitan',
      coordinates: [51.5634, -0.2793],
      userBehavior: "Temporary, event-specific signage is overlaid on permanent wayfinding.", 
      navigationAids: "Temporary signage, permanent wayfinding.", 
      concept: "Context-aware information: Temporary match day signage at Wembley Park demonstrates how physical environments adapt information presentation based on contextual factors‚Äîa principle that should guide adaptive digital interfaces." },
      
    { id: 'wembley-approach-wide', name: 'Wembley Approach (Wide)', neighborhood: 'Wembley', tubeStop: 'Wembley Park', tubeLine: 'metropolitan',
      coordinates: [51.5560, -0.2795],
      userBehavior: "Generous width of Olympic Way handles mass movement, preventing bottlenecks.", 
      navigationAids: "Wide pedestrian approach (Olympic Way).", 
      concept: "Olympic Way's generous width serves as a physical manifestation of digital load balancing, designed to prevent bottlenecks during peak flows." },
      
    { id: 'boxpark-wembley-mixed', name: 'BOXPARK Wembley (Mixed Scale)', neighborhood: 'Wembley', tubeStop: 'Wembley Park', tubeLine: 'metropolitan',
      coordinates: [51.5625, -0.2805],
      userBehavior: "Auxiliary spaces absorb excess crowd capacity before and after events.", 
      navigationAids: "Gathering spaces (BOXPARK).", 
      concept: "BOXPARK Wembley functions as a system buffer, absorbing excess crowd capacity before and after events to prevent stadium bottlenecks." },
    
    // Liverpool Street
    { id: 'liverpool-street-info', name: 'Liverpool Street (Info Board)', neighborhood: 'Liverpool Street', tubeStop: 'Liverpool Street', tubeLine: 'central',
      coordinates: [51.5183, -0.0818],
      userBehavior: "Commuters scan information boards for relevant departure details.", 
      navigationAids: "Information boards with timetables.", 
      concept: "Users selectively filter information based on relevance to their journey." },
      
    { id: 'liverpool-street-concourse', name: 'Liverpool Street Concourse (Wide)', neighborhood: 'Liverpool Street', tubeStop: 'Liverpool Street', tubeLine: 'central',
      coordinates: [51.5185, -0.0822],
      userBehavior: "Travelers orient themselves within the station concourse.", 
      navigationAids: "Open architectural space, visible pathways.", 
      concept: "The open concourse design provides natural orientation through spatial hierarchy." },
      
    { id: 'liverpool-street-elevator', name: 'Liverpool Street Elevator (Detail)', neighborhood: 'Liverpool Street', tubeStop: 'Liverpool Street', tubeLine: 'central',
      coordinates: [51.5188, -0.0820],
      userBehavior: "Users choose between stairs and elevators based on needs and signage.", 
      navigationAids: "Elevator interfaces, accessibility signage.", 
      concept: "Diverse navigation options catering to different user capabilities and preferences." },
    
    // Victoria
    { id: 'victoria-station-concourse', name: 'Victoria Station Concourse', neighborhood: 'Victoria', tubeStop: 'Victoria', tubeLine: 'victoria',
      coordinates: [51.4952, -0.1438],
      userBehavior: "Travelers navigate through a high-volume transitional space.", 
      navigationAids: "Clear signage, architectural cues.", 
      concept: "Victoria Station's design manages high volume user flow through clear directional cues." },
    
    // Legible London
    { id: 'legible-london-display', name: 'Legible London Display', neighborhood: 'Various', tubeStop: 'Various', tubeLine: 'multiple',
      coordinates: [51.5100, -0.1350],
      userBehavior: "Pedestrians orient themselves using the mapped information.", 
      navigationAids: "Map display, directional information.", 
      concept: "Legible London provides consistent orienting information throughout the city." },
      
    { id: 'legible-london-pillar', name: 'Legible London Pillar (Detail)', neighborhood: 'Various', tubeStop: 'Various', tubeLine: 'multiple',
      coordinates: [51.5088, -0.1272],
      userBehavior: "Users approach and interact with wayfinding elements.", 
      navigationAids: "Pillar design, consistent mapping.", 
      concept: "Consistent design language creates system recognition across the city." },
      
    { id: 'legible-london-signage', name: 'Legible London Signage (Detail)', neighborhood: 'Various', tubeStop: 'Various', tubeLine: 'multiple',
      coordinates: [51.5065, -0.1260],
      userBehavior: "Pedestrians read and interpret directional signage.", 
      navigationAids: "Walking time indicators, directional arrows.", 
      concept: "Information density adjusted based on user needs at specific decision points." },
    
    // Barbican
    { id: 'barbican-junction', name: 'Barbican Junction Point', neighborhood: 'Barbican', tubeStop: 'Barbican', tubeLine: 'metropolitan',
      coordinates: [51.5204, -0.0970],
      userBehavior: "Users navigate complex pathways in the brutalist architecture.", 
      navigationAids: "Architectural cues, signage.", 
      concept: "The Barbican's complex pathway system requires strategic wayfinding interventions." },
      
    { id: 'barbican-signage', name: 'Barbican Signage Detail', neighborhood: 'Barbican', tubeStop: 'Barbican', tubeLine: 'metropolitan',
      coordinates: [51.5201, -0.0975],
      userBehavior: "Visitors follow specialized signage within the complex.", 
      navigationAids: "Custom signage system integrated with architecture.", 
      concept: "Barbican's unique signage system matches its distinctive architectural identity." },
      
    { id: 'barbican-hidden', name: 'Barbican Hidden Destination', neighborhood: 'Barbican', tubeStop: 'Barbican', tubeLine: 'metropolitan',
      coordinates: [51.5208, -0.0977],
      userBehavior: "Visitors discover hidden or less obvious destinations.", 
      navigationAids: "Subtle architectural cues, minimal signage.", 
      concept: "The Barbican rewards exploration with discovery of unexpected spaces." },
    
    // Kings Cross
    { id: 'kings-cross-transition', name: 'King\'s Cross Level Transition', neighborhood: 'King\'s Cross', tubeStop: 'King\'s Cross', tubeLine: 'northern',
      coordinates: [51.5308, -0.1244],
      userBehavior: "Users navigate vertical transitions between levels.", 
      navigationAids: "Staircases, escalators, visual connections.", 
      concept: "King's Cross station's redesign creates clear vertical navigation between different functional levels." },
      
    { id: 'kings-cross-material', name: 'King\'s Cross Material Continuity', neighborhood: 'King\'s Cross', tubeStop: 'King\'s Cross', tubeLine: 'northern',
      coordinates: [51.5310, -0.1240],
      userBehavior: "Travelers follow continuous material cues through the space.", 
      navigationAids: "Consistent materials, architectural elements.", 
      concept: "Material consistency creates intuitive pathways through complex spaces." },
    
    // Old Street
    { id: 'old-street-roundabout', name: 'Old Street Roundabout Aerial', neighborhood: 'Old Street', tubeStop: 'Old Street', tubeLine: 'northern',
      coordinates: [51.5263, -0.0878],
      userBehavior: "Multiple transportation types converge and navigate a complex junction.", 
      navigationAids: "Traffic signals, lane markings, barriers.", 
      concept: "The roundabout manages conflicting user types and intentions in a shared space." },
      
    { id: 'old-street-exit', name: 'Old Street Exit Decision', neighborhood: 'Old Street', tubeStop: 'Old Street', tubeLine: 'northern',
      coordinates: [51.5266, -0.0880],
      userBehavior: "Commuters choose between multiple exits based on their destination.", 
      navigationAids: "Exit numbering, local area maps.", 
      concept: "Multiple exits create a decision point requiring clear information." },
    
    // Tokyo (for comparison)
    { id: 'tokyo-station-comparative', name: 'Tokyo Station Comparative', neighborhood: 'International', tubeStop: 'N/A', tubeLine: 'multiple',
      coordinates: [51.5118, -0.1271], // This is actually shown in London for comparative display
      userBehavior: "Foreign visitors navigate using universal design principles.", 
      navigationAids: "Universal symbols, color coding.", 
      concept: "Tokyo's station design uses universal principles that transcend language barriers." },
    
    // Leicester Square
    { id: 'leicester-square-wide', name: 'Leicester Square (Wide)', neighborhood: 'Leicester Square', tubeStop: 'Leicester Square', tubeLine: 'piccadilly',
      coordinates: [51.5110, -0.1281],
      userBehavior: "Tourists and locals share a busy public space with different goals.", 
      navigationAids: "Open plaza design, focal points.", 
      concept: "Leicester Square balances needs of tourists seeking entertainment and locals in transit." },
      
    { id: 'leicester-square-decision', name: 'Leicester Square (Decision Point)', neighborhood: 'Leicester Square', tubeStop: 'Leicester Square', tubeLine: 'piccadilly',
      coordinates: [51.5105, -0.1285],
      userBehavior: "Visitors make choices at key junction points in the area.", 
      navigationAids: "Commercial signage, architectural landmarks.", 
      concept: "Commercial environments create competing visual hierarchies for user attention." },
    
    // Borough
    { id: 'borough-high-wide', name: 'Borough High Street (Wide)', neighborhood: 'Borough', tubeStop: 'Borough', tubeLine: 'northern',
      coordinates: [51.5011, -0.0945],
      userBehavior: "Pedestrians navigate a historic streetscape with modern elements.", 
      navigationAids: "Historic architecture, street patterns.", 
      concept: "Borough High Street blends historic navigation patterns with modern interventions." },
      
    { id: 'borough-high-transition', name: 'Borough High Street (Transition)', neighborhood: 'Borough', tubeStop: 'Borough', tubeLine: 'northern',
      coordinates: [51.5008, -0.0943],
      userBehavior: "Users transition between different neighborhood characters.", 
      navigationAids: "Architectural shifts, changing streetscape.", 
      concept: "Street transitions signal different neighborhood zones and functions." },
      
    { id: 'borough-high-closeup', name: 'Borough High Street (Close-up)', neighborhood: 'Borough', tubeStop: 'Borough', tubeLine: 'northern',
      coordinates: [51.5014, -0.0947],
      userBehavior: "Pedestrians engage with street-level details and businesses.", 
      navigationAids: "Shopfronts, signage, street furniture.", 
      concept: "Street-level details create engagement within the larger urban framework." },
    
    // Farringdon
    { id: 'farringdon-external', name: 'Farringdon (External View)', neighborhood: 'Farringdon', tubeStop: 'Farringdon', tubeLine: 'elizabeth',
      coordinates: [51.5203, -0.1053],
      userBehavior: "Commuters approach the station entrance from multiple directions.", 
      navigationAids: "Architectural prominence, station signage.", 
      concept: "Farringdon's design clearly signals its function as a transportation hub." },
      
    { id: 'farringdon-junction', name: 'Farringdon (Junction)', neighborhood: 'Farringdon', tubeStop: 'Farringdon', tubeLine: 'elizabeth',
      coordinates: [51.5200, -0.1050],
      userBehavior: "Travelers navigate between different transportation systems.", 
      navigationAids: "Transfer signage, architectural connections.", 
      concept: "Junction points between transportation systems require clear transitional guidance." },
    
    // Canary Wharf
    { id: 'canary-wharf-wide', name: 'Canary Wharf (Wide)', neighborhood: 'Canary Wharf', tubeStop: 'Canary Wharf', tubeLine: 'jubilee',
      coordinates: [51.5055, -0.0175],
      userBehavior: "Users navigate a controlled corporate environment.", 
      navigationAids: "Planned layout, consistent design language.", 
      concept: "Canary Wharf's master-planned environment creates predictable navigation patterns." },
      
    { id: 'canary-wharf-decision', name: 'Canary Wharf (Decision Points)', neighborhood: 'Canary Wharf', tubeStop: 'Canary Wharf', tubeLine: 'jubilee',
      coordinates: [51.5050, -0.0180],
      userBehavior: "Office workers and visitors navigate decision points in the complex.", 
      navigationAids: "Directional signage, maps, architectural cues.", 
      concept: "Well-designed decision points reduce cognitive load in complex environments." },
      
    { id: 'canary-wharf-underground', name: 'Canary Wharf (Underground)', neighborhood: 'Canary Wharf', tubeStop: 'Canary Wharf', tubeLine: 'jubilee',
      coordinates: [51.5040, -0.0170],
      userBehavior: "Commuters transition between underground transport and surface environment.", 
      navigationAids: "Architectural transitions, escalators, light wells.", 
      concept: "The station's design creates a gradual transition from underground to surface environments." },
    
    // Duke of York Square
    { id: 'duke-of-york-seating', name: 'Duke of York Square (Seating)', neighborhood: 'Chelsea', tubeStop: 'Sloane Square', tubeLine: 'district',
      coordinates: [51.4918, -0.1590],
      userBehavior: "Visitors pause and occupy the public space for different durations.", 
      navigationAids: "Seating arrangements, spatial organization.", 
      concept: "Seating design influences flow, lingering, and social interaction patterns." },
    
    // Trafalgar Square
    { id: 'trafalgar-square-wide', name: 'Trafalgar Square (Wide)', neighborhood: 'Trafalgar Square', tubeStop: 'Charing Cross', tubeLine: 'northern',
      coordinates: [51.5080, -0.1280],
      userBehavior: "Tourists and locals navigate a major public space with multiple focal points.", 
      navigationAids: "Landmarks, open sight lines, spatial hierarchy.", 
      concept: "Trafalgar Square's design creates natural focal points and circulation patterns." },
      
    { id: 'trafalgar-square-user', name: 'Trafalgar Square (User Behavior)', neighborhood: 'Trafalgar Square', tubeStop: 'Charing Cross', tubeLine: 'northern',
      coordinates: [51.5078, -0.1284],
      userBehavior: "Different visitor types create distinct usage patterns in the space.", 
      navigationAids: "Self-organizing crowd patterns, desire lines.", 
      concept: "Observing how different user types create distinct spatial usage patterns." },
    
    // Spencer Park
    { id: 'spencer-park-entrance', name: 'Spencer Park (Entrance)', neighborhood: 'Wandsworth', tubeStop: 'Wandsworth Town', tubeLine: 'overground',
      coordinates: [51.4605, -0.1860],
      userBehavior: "Local residents access a semi-private community park.", 
      navigationAids: "Gated entrance, community signage.", 
      concept: "The park entrance balances accessibility with community ownership." },
      
    { id: 'spencer-park-users', name: 'Spencer Park (Regular Users)', neighborhood: 'Wandsworth', tubeStop: 'Wandsworth Town', tubeLine: 'overground',
      coordinates: [51.4608, -0.1865],
      userBehavior: "Regular users navigate familiar space with established patterns.", 
      navigationAids: "Familiarity, community knowledge.", 
      concept: "Regular users develop efficient navigation patterns through familiarity." },
      
    { id: 'spencer-park-hierarchy', name: 'Spencer Park (Spatial Hierarchy)', neighborhood: 'Wandsworth', tubeStop: 'Wandsworth Town', tubeLine: 'overground',
      coordinates: [51.4610, -0.1862],
      userBehavior: "Visitors navigate between different activity zones in the park.", 
      navigationAids: "Spatial organization, pathway hierarchy.", 
      concept: "The park's spatial hierarchy guides users to appropriate activity zones." },
    
    // Camley Street
    { id: 'camley-street-entrance', name: 'Camley Street (Entrance Sequence)', neighborhood: 'King\'s Cross', tubeStop: 'King\'s Cross', tubeLine: 'northern',
      coordinates: [51.5344, -0.1258],
      userBehavior: "Visitors transition from urban environment to nature reserve.", 
      navigationAids: "Entrance sequence, transitional design.", 
      concept: "The entrance sequence prepares visitors for a shift in context and attention." },
      
    { id: 'camley-street-richness', name: 'Camley Street (Compact Richness)', neighborhood: 'King\'s Cross', tubeStop: 'King\'s Cross', tubeLine: 'northern',
      coordinates: [51.5346, -0.1260],
      userBehavior: "Visitors explore densely-designed small space with multiple elements.", 
      navigationAids: "Pathway design, interpretive elements.", 
      concept: "The nature park demonstrates how to create richness in a compact space." },
      
    { id: 'camley-street-behavior', name: 'Camley Street (Visitor Behavior)', neighborhood: 'King\'s Cross', tubeStop: 'King\'s Cross', tubeLine: 'northern',
      coordinates: [51.5348, -0.1262],
      userBehavior: "Nature reserve visitors demonstrate different engagement patterns.", 
      navigationAids: "Interpretive signage, viewing platforms.", 
      concept: "Observing how different visitor types engage with educational elements." },
    
    // Gasholder Park
    { id: 'gasholder-park-approach', name: 'Gasholder Park (Approach)', neighborhood: 'King\'s Cross', tubeStop: 'King\'s Cross', tubeLine: 'northern',
      coordinates: [51.5354, -0.1253],
      userBehavior: "Visitors approach and discover the repurposed industrial structure.", 
      navigationAids: "Visual landmark, architectural framing.", 
      concept: "The gasholders create a distinctive landmark that signals a destination." },
      
    { id: 'gasholder-park-frame', name: 'Gasholder Park (Internal Frame)', neighborhood: 'King\'s Cross', tubeStop: 'King\'s Cross', tubeLine: 'northern',
      coordinates: [51.5356, -0.1252],
      userBehavior: "Users experience the contrast between industrial structure and green space.", 
      navigationAids: "Circular framework, central green.", 
      concept: "The industrial frame creates a distinctive context for the park experience." },
      
    { id: 'gasholder-park-positioning', name: 'Gasholder Park (User Positioning)', neighborhood: 'King\'s Cross', tubeStop: 'King\'s Cross', tubeLine: 'northern',
      coordinates: [51.5355, -0.1251],
      userBehavior: "Visitors position themselves within the circular space.", 
      navigationAids: "Circular pathways, central lawn.", 
      concept: "The circular form creates natural positioning and circulation patterns." },
      
    { id: 'gasholder-park-lighting', name: 'Gasholder Park (Night Lighting)', neighborhood: 'King\'s Cross', tubeStop: 'King\'s Cross', tubeLine: 'northern',
      coordinates: [51.5357, -0.1250],
      userBehavior: "Night visitors navigate and experience the illuminated structure.", 
      navigationAids: "Architectural lighting, pathway illumination.", 
      concept: "Lighting transforms the user experience and navigation during night hours." },
    
    // Camden Market
    { id: 'camden-market-entrance', name: 'Camden Market Entrance', neighborhood: 'Camden', tubeStop: 'Camden Town', tubeLine: 'northern',
      coordinates: [51.5394, -0.1427],
      userBehavior: "Visitors enter a complex, organic marketplace environment.", 
      navigationAids: "Gateway architecture, commercial signage.", 
      concept: "The market entrance signals transition to a different commercial environment." },
      
    { id: 'camden-market-pathway', name: 'Camden Market Pathway', neighborhood: 'Camden', tubeStop: 'Camden Town', tubeLine: 'northern',
      coordinates: [51.5398, -0.1428],
      userBehavior: "Shoppers navigate narrow, winding paths with high visual complexity.", 
      navigationAids: "Pathway design, overhead signage.", 
      concept: "Market pathways balance discovery with navigability." },
      
    { id: 'camden-market-stall', name: 'Camden Market Stall Detail', neighborhood: 'Camden', tubeStop: 'Camden Town', tubeLine: 'northern',
      coordinates: [51.5396, -0.1430],
      userBehavior: "Customers interact with individual market stalls amidst visual complexity.", 
      navigationAids: "Stall design, product displays.", 
      concept: "Stall design must attract attention within a visually competitive environment." },
    
    // Hampstead
    { id: 'hampstead-luxury', name: 'Hampstead (Luxury Shopfronts)', neighborhood: 'Hampstead', tubeStop: 'Hampstead', tubeLine: 'northern',
      coordinates: [51.5570, -0.1782],
      userBehavior: "Shoppers engage with high-end retail environments.", 
      navigationAids: "Luxury signaling, storefront design.", 
      concept: "Retail design elements that signal premium experiences." },
      
    { id: 'hampstead-window', name: 'Hampstead (Window Display)', neighborhood: 'Hampstead', tubeStop: 'Hampstead', tubeLine: 'northern',
      coordinates: [51.5566, -0.1778],
      userBehavior: "Pedestrians pause to engage with curated window displays.", 
      navigationAids: "Window design, product curation.", 
      concept: "Window displays create moments of engagement in the pedestrian journey." },
    
    // Bermondsey
    { id: 'bermondsey-street-character', name: 'Bermondsey Street (Character)', neighborhood: 'Bermondsey', tubeStop: 'Bermondsey', tubeLine: 'jubilee',
      coordinates: [51.4982, -0.0635],
      userBehavior: "Visitors experience the distinctive character of the historic street.", 
      navigationAids: "Historic architecture, street width.", 
      concept: "The street's character creates a distinctive experiential context." },
      
    { id: 'bermondsey-street-cafe', name: 'Bermondsey Street (Caf√©)', neighborhood: 'Bermondsey', tubeStop: 'Bermondsey', tubeLine: 'jubilee',
      coordinates: [51.4986, -0.0637],
      userBehavior: "People linger in the transitional space between cafe and street.", 
      navigationAids: "Outdoor seating, facade design.", 
      concept: "Cafe frontage creates a social buffer zone between public and private." },
      
    { id: 'bermondsey-street-material', name: 'Bermondsey Street (Material)', neighborhood: 'Bermondsey', tubeStop: 'Bermondsey', tubeLine: 'jubilee',
      coordinates: [51.4984, -0.0633],
      userBehavior: "Pedestrians navigate using material and textural cues.", 
      navigationAids: "Street materials, textural changes.", 
      concept: "Material changes subtly communicate functional zones and transitions." },
    
    // Friction Examples
    { id: 'good-bad-friction', name: 'Good vs. Bad Friction (Comparative)', neighborhood: 'Various', tubeStop: 'Various', tubeLine: 'multiple',
      coordinates: [51.5070, -0.1100],
      userBehavior: "Users navigate intentional vs. unintentional friction points.", 
      navigationAids: "Various intentional and unintentional barriers.", 
      concept: "Comparing examples of helpful friction (for safety) vs. unhelpful friction (poor design)." },
    
    // London Bridge
    { id: 'london-bridge-wide', name: 'London Bridge Station (Wide)', neighborhood: 'London Bridge', tubeStop: 'London Bridge', tubeLine: 'northern',
      coordinates: [51.5050, -0.0865],
      userBehavior: "Commuters navigate a major transportation hub with multiple systems.", 
      navigationAids: "Architectural organization, signage systems.", 
      concept: "The station design organizes multiple transportation systems clearly." },
      
    { id: 'london-bridge-decision', name: 'London Bridge Station (Decision Point)', neighborhood: 'London Bridge', tubeStop: 'London Bridge', tubeLine: 'northern',
      coordinates: [51.5055, -0.0870],
      userBehavior: "Travelers make choices at critical junction points.", 
      navigationAids: "Decision-point signage, sight lines.", 
      concept: "Station redesign places clear information at key decision points." },
      
    { id: 'london-bridge-user', name: 'London Bridge Station (User Behavior)', neighborhood: 'London Bridge', tubeStop: 'London Bridge', tubeLine: 'northern',
      coordinates: [51.5052, -0.0868],
      userBehavior: "Different user types (tourists, commuters) create varied movement patterns.", 
      navigationAids: "Observing natural user flows and pain points.", 
      concept: "Observing how different user types navigate the same environment." },
    
    // Fenchurch Street
    { id: 'fenchurch-street-inconsistency', name: 'Fenchurch Street (Inconsistency)', neighborhood: 'City of London', tubeStop: 'Tower Hill', tubeLine: 'circle',
      coordinates: [51.5115, -0.0780],
      userBehavior: "Users navigate despite inconsistent or contradictory information.", 
      navigationAids: "Inconsistent or outdated signage elements.", 
      concept: "Documenting how inconsistent navigation systems create confusion." },
    
    // User Behavior
    { id: 'user-behavior-decision', name: 'User Behavior (Decision Point)', neighborhood: 'Various', tubeStop: 'Various', tubeLine: 'multiple',
      coordinates: [51.5085, -0.1290],
      userBehavior: "People pause and orient at key decision points.", 
      navigationAids: "Observing orientation behaviors at junctions.", 
      concept: "Documenting common behavioral patterns at navigation decision points." },
      
    { id: 'user-behavior-intersection', name: 'User Behavior (Intersection)', neighborhood: 'Various', tubeStop: 'Various', tubeLine: 'multiple',
      coordinates: [51.5095, -0.1300],
      userBehavior: "People negotiate shared space at pathway intersections.", 
      navigationAids: "Observing social navigation protocols.", 
      concept: "How users develop informal protocols for navigating shared spaces." },
    
    // Parkland Walk
    { id: 'parkland-walk-linear', name: 'Parkland Walk (Linear)', neighborhood: 'Finsbury Park', tubeStop: 'Finsbury Park', tubeLine: 'victoria',
      coordinates: [51.5642, -0.1066],
      userBehavior: "Users follow a linear path with limited decision points.", 
      navigationAids: "Clear pathway, sequential experience.", 
      concept: "Linear paths create simple navigation with focus on the journey experience." },
      
    { id: 'parkland-walk-junction', name: 'Parkland Walk (Junction)', neighborhood: 'Finsbury Park', tubeStop: 'Finsbury Park', tubeLine: 'victoria',
      coordinates: [51.5645, -0.1068],
      userBehavior: "Walkers make choices at path junctions with limited information.", 
      navigationAids: "Junction design, limited signage.", 
      concept: "Junction design influences decision-making with minimal explicit guidance." },
    
    // Regent's Park
    { id: 'regents-park-network', name: 'Regent\'s Park (Path Network)', neighborhood: 'Regent\'s Park', tubeStop: 'Regent\'s Park', tubeLine: 'bakerloo',
      coordinates: [51.5260, -0.1460],
      userBehavior: "Park visitors navigate an extensive path network with multiple options.", 
      navigationAids: "Path hierarchy, landmark features.", 
      concept: "The park's network design offers multiple valid routes to destinations." },
      
    { id: 'regents-park-map', name: 'Regent\'s Park (Map Usage)', neighborhood: 'Regent\'s Park', tubeStop: 'Regent\'s Park', tubeLine: 'bakerloo',
      coordinates: [51.5255, -0.1456],
      userBehavior: "Visitors consult maps to orient in the extensive space.", 
      navigationAids: "Park maps, you-are-here indicators.", 
      concept: "Maps provide necessary context in extensive environments with many options." }
];


            
            // For a real implementation, you would use all locations from the original data
            // For brevity and testing, we're using a subset here
            
            // Tube station coordinates (approximated)
            const tubeStationCoordinates = {
                'Oxford Circus': [51.5152, -0.1415],
    'Covent Garden': [51.5129, -0.1243],
    'Battersea Park': [51.4770, -0.1467],
    'Battersea Power Station': [51.4810, -0.1428],
    'Hyde Park Corner': [51.5027, -0.1527],
    'Stratford': [51.5416, -0.0042],
    'Various': [51.5074, -0.1278], // Central London
    'Hounslow Central': [51.4713, -0.3665],
    'Westminster': [51.5014, -0.1257],
    'Cutty Sark': [51.4827, -0.0096],
    'Waterloo': [51.5036, -0.1143],
    'Wembley Park': [51.5635, -0.2795],
    'Liverpool Street': [51.5188, -0.0814],
    'Victoria': [51.4965, -0.1447],
    'Barbican': [51.5204, -0.0979],
    'King\'s Cross': [51.5308, -0.1238],
    'Old Street': [51.5263, -0.0873],
    'Leicester Square': [51.5113, -0.1281],
    'Borough': [51.5011, -0.0943],
    'Farringdon': [51.5203, -0.1053],
    'Canary Wharf': [51.5053, -0.0172],
    'Sloane Square': [51.4924, -0.1565],
    'Charing Cross': [51.5080, -0.1247],
    'Wandsworth Town': [51.4618, -0.1870],
    'Camden Town': [51.5394, -0.1426],
    'Hampstead': [51.5568, -0.1780],
    'Bermondsey': [51.4979, -0.0637],
    'London Bridge': [51.5050, -0.0865],
    'Tower Hill': [51.5108, -0.0766],
    'Finsbury Park': [51.5642, -0.1066],
    'Regent\'s Park': [51.5234, -0.1466],
    'N/A': [51.5074, -0.1278] // Default for international comparisons
};
            
            // Tube line colors for markers
            const tubeLineColors = {
                'bakerloo': '#B36305',
                'central': '#E32017',
                'circle': '#FFD300',
                'district': '#00782A',
                'hammersmith': '#F3A9BB',
                'jubilee': '#A0A5A9',
                'metropolitan': '#9B0056',
                'northern': '#000000',
                'piccadilly': '#003688',
                'victoria': '#0098D4',
                'waterloo': '#95CDBA',
                'elizabeth': '#6950a1',
                'dlr': '#00A4A7',
                'overground': '#EE7C0E',
                'multiple': '#666666'
            };
            
            // Initialize the map
            const map = L.map('map', {
                zoomControl: false,
                attributionControl: true,
                attributionPosition: 'bottomleft'
            }).setView([51.5074, -0.1278], 12); // Center on London
            
            // Add zoom control with a better position for mobile
            L.control.zoom({
                position: 'bottomright'
            }).addTo(map);
            
            // Add OpenStreetMap tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Create feature group for location markers
            const markers = L.featureGroup().addTo(map);
            
            // Get coordinates with offset to prevent markers from stacking
            function getOffsetCoordinates(tubeStop, index) {
                if (!tubeStationCoordinates[tubeStop]) {
                    console.warn(`No coordinates for tube stop: ${tubeStop}`);
                    return tubeStationCoordinates['Various'];
                }
                
                // Calculate offset based on index to avoid marker overlap
                const baseCoords = tubeStationCoordinates[tubeStop];
                const offsetLat = baseCoords[0] + (index * 0.0002);
                const offsetLng = baseCoords[1] + (index * 0.0002);
                
                return [offsetLat, offsetLng];
            }
            
            // Create popup content for markers
            function createPopupContent(location) {
                const content = document.createElement('div');
                content.className = 'popup-content';
                
                const title = document.createElement('h3');
                title.textContent = location.name;
                content.appendChild(title);
                
                // Tube stop info with line color
                const tubeStopInfo = document.createElement('div');
                tubeStopInfo.className = 'tube-stop-info';
                
                const tubeLineSpan = document.createElement('span');
                tubeLineSpan.className = `tube-line tube-line-${location.tubeLine}`;
                tubeStopInfo.appendChild(tubeLineSpan);
                
                const tubeStopText = document.createTextNode(`${location.tubeStop} (${location.neighborhood})`);
                tubeStopInfo.appendChild(tubeStopText);
                content.appendChild(tubeStopInfo);
                
                // Add details if available
                if (location.concept) {
                    addDetail(content, 'Photo Concept', location.concept);
                }
                
                if (location.userBehavior) {
                    addDetail(content, 'User Behavior', location.userBehavior);
                }
                
                if (location.navigationAids) {
                    addDetail(content, 'Navigation Elements', location.navigationAids);
                }
                
                // Add completion checkbox
                const completionContainer = document.createElement('div');
                completionContainer.className = 'completed-checkbox';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `completed-${location.id}`;
                checkbox.checked = isLocationCompleted(location.id);
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = 'Mark as completed';
                
                // Add event listener to checkbox
                checkbox.addEventListener('change', function() {
                    setLocationCompleted(location.id, this.checked);
                    
                    // Update marker appearance
                    markers.eachLayer(function(layer) {
                        if (layer.options.locationId === location.id) {
                            const newIcon = L.divIcon({
                                className: 'custom-marker',
                                html: `<div class="marker-pin ${checkbox.checked ? 'marker-pin-completed' : ''}" style="background-color: ${tubeLineColors[location.tubeLine] || '#666666'};"></div>`,
                                iconSize: [30, 30],
                                iconAnchor: [15, 30],
                                popupAnchor: [0, -30]
                            });
                            layer.setIcon(newIcon);
                        }
                    });
                });
                
                completionContainer.appendChild(checkbox);
                completionContainer.appendChild(label);
                content.appendChild(completionContainer);
                
                return content;
            }
            
            // Helper to add detail rows to popup
            function addDetail(container, label, text) {
                const detail = document.createElement('div');
                detail.className = 'popup-detail';
                
                const labelElem = document.createElement('div');
                labelElem.className = 'popup-label';
                labelElem.textContent = label + ':';
                detail.appendChild(labelElem);
                
                const value = document.createElement('div');
                value.textContent = text;
                detail.appendChild(value);
                
                container.appendChild(detail);
            }
            
            // Helper functions for location completion tracking
            function getCompletedLocations() {
                try {
                    const saved = localStorage.getItem('completedLocations');
                    return saved ? JSON.parse(saved) : {};
                } catch (e) {
                    console.error('Error loading completed locations', e);
                    return {};
                }
            }
            
            function saveCompletedLocations(completed) {
                try {
                    localStorage.setItem('completedLocations', JSON.stringify(completed));
                } catch (e) {
                    console.error('Error saving completed locations', e);
                }
            }
            
            function isLocationCompleted(locationId) {
                return completedLocations[locationId] === true;
            }
            
            function setLocationCompleted(locationId, isCompleted) {
                if (isCompleted) {
                    completedLocations[locationId] = true;
                } else {
                    delete completedLocations[locationId];
                }
                saveCompletedLocations(completedLocations);
                applyFilters(); // Refresh markers when completion status changes
            }
            
            function resetAllCompletions() {
                if (confirm('Are you sure you want to reset all completed locations?')) {
                    completedLocations = {};
                    saveCompletedLocations(completedLocations);
                    applyFilters(); // Refresh markers
                }
            }
            
            // Calculate distance between two points in km using the Haversine formula
            function getDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // Radius of the earth in km
                const dLat = deg2rad(lat2 - lat1);
                const dLon = deg2rad(lon2 - lon1);
                const a = 
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2); 
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
                const distance = R * c; // Distance in km
                return distance;
            }
            
            function deg2rad(deg) {
                return deg * (Math.PI/180);
            }
            
            // Create markers on the map
            function createMarkers(filteredLocations = null) {
                // Clear existing markers
                markers.clearLayers();
                
                const locationsToShow = filteredLocations || locations;
                document.getElementById('locationCount').textContent = locationsToShow.length;
                
                // Count locations per tube stop for offset calculations
                const tubeStopCounts = {};
                const tubeStopIndices = {};
                
                locationsToShow.forEach(location => {
                    // Initialize or increment index
                    tubeStopIndices[location.tubeStop] = tubeStopIndices[location.tubeStop] || 0;
                    const currentIndex = tubeStopIndices[location.tubeStop]++;
                    
                    // Get coordinates with offset
                    const coords = location.coordinates;
                                        
                    // Create custom icon with tube line color
                    const tubeLineColor = tubeLineColors[location.tubeLine] || '#666666';
                    const isCompleted = isLocationCompleted(location.id);
                    
                    const customIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div class="marker-pin ${isCompleted ? 'marker-pin-completed' : ''}" style="background-color: ${tubeLineColor};"></div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 30],
                        popupAnchor: [0, -30]
                    });
                    
                    // Create marker
                    const marker = L.marker(coords, { 
                        icon: customIcon,
                        locationId: location.id // Store the ID for later reference
                    })
                        .bindPopup(createPopupContent(location))
                        .addTo(markers);
                });
                
                // Fit map bounds if we have markers
                if (markers.getLayers().length > 0) {
                    map.fitBounds(markers.getBounds(), { padding: [30, 30] });
                }
            }
            
            // Generate filter checkboxes for neighborhoods
            function generateNeighborhoodFilters() {
                const container = document.getElementById('neighborhoodFilters');
                const neighborhoods = new Set();
                
                // Collect unique neighborhoods
                locations.forEach(location => {
                    neighborhoods.add(location.neighborhood);
                });
                
                // Sort alphabetically
                const sortedNeighborhoods = Array.from(neighborhoods).sort();
                
                // Create checkboxes
                sortedNeighborhoods.forEach(neighborhood => {
                    const filterItem = document.createElement('div');
                    filterItem.className = 'tube-filter';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = true;
                    checkbox.id = `neighborhood-${neighborhood.replace(/\s+/g, '-').toLowerCase()}`;
                    checkbox.dataset.neighborhood = neighborhood;
                    checkbox.className = 'neighborhood-filter-checkbox';
                    
                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.textContent = neighborhood;
                    
                    filterItem.appendChild(checkbox);
                    filterItem.appendChild(label);
                    container.appendChild(filterItem);
                    
                    // Add event listener
                    checkbox.addEventListener('change', applyFilters);
                });
            }
            
            // Generate filter checkboxes for tube lines
            function generateTubeLineFilters() {
                const container = document.getElementById('tubeLineFilters');
                const tubeLineNames = {
                    'bakerloo': 'Bakerloo Line',
                    'central': 'Central Line',
                    'circle': 'Circle Line',
                    'district': 'District Line',
                    'hammersmith': 'Hammersmith & City Line',
                    'jubilee': 'Jubilee Line',
                    'metropolitan': 'Metropolitan Line',
                    'northern': 'Northern Line',
                    'piccadilly': 'Piccadilly Line',
                    'victoria': 'Victoria Line',
                    'waterloo': 'Waterloo & City Line',
                    'elizabeth': 'Elizabeth Line',
                    'dlr': 'DLR',
                    'overground': 'Overground',
                    'multiple': 'Multiple Lines'
                };
                
                const tubeLines = new Set();
                
                // Collect unique tube lines
                locations.forEach(location => {
                    tubeLines.add(location.tubeLine);
                });
                
                // Create checkboxes
                Array.from(tubeLines).sort().forEach(line => {
                    const lineName = tubeLineNames[line] || line;
                    
                    const filterItem = document.createElement('div');
                    filterItem.className = 'tube-filter';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = true;
                    checkbox.id = `tubeline-${line}`;
                    checkbox.dataset.tubeLine = line;
                    checkbox.className = 'tubeline-filter-checkbox';
                    
                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    
                    const tubeLineSpan = document.createElement('span');
                    tubeLineSpan.className = `tube-line tube-line-${line}`;
                    
                    label.appendChild(tubeLineSpan);
                    label.appendChild(document.createTextNode(` ${lineName}`));
                    
                    filterItem.appendChild(checkbox);
                    filterItem.appendChild(label);
                    container.appendChild(filterItem);
                    
                    // Add event listener
                    checkbox.addEventListener('change', applyFilters);
                });
            }
            
            // Apply filters based on search, neighborhoods, tube lines, and completion status
            function applyFilters() {
                const searchText = document.getElementById('search').value.toLowerCase();
                const hideCompleted = document.getElementById('hideCompleted').checked;
                
                // Get selected neighborhoods
                const selectedNeighborhoods = new Set();
                document.querySelectorAll('.neighborhood-filter-checkbox').forEach(checkbox => {
                    if (checkbox.checked) {
                        selectedNeighborhoods.add(checkbox.dataset.neighborhood);
                    }
                });
                
                // Get selected tube lines
                const selectedTubeLines = new Set();
                document.querySelectorAll('.tubeline-filter-checkbox').forEach(checkbox => {
                    if (checkbox.checked) {
                        selectedTubeLines.add(checkbox.dataset.tubeLine);
                    }
                });
                
                // Filter locations
                const filteredLocations = locations.filter(location => {
                    // Completion filter
                    if (hideCompleted && isLocationCompleted(location.id)) {
                        return false;
                    }
                    
                    // Search filter
                    const matchesSearch = searchText === '' || 
                        location.name.toLowerCase().includes(searchText) ||
                        location.neighborhood.toLowerCase().includes(searchText) ||
                        location.tubeStop.toLowerCase().includes(searchText) ||
                        (location.concept && location.concept.toLowerCase().includes(searchText)) ||
                        (location.userBehavior && location.userBehavior.toLowerCase().includes(searchText));
                    
                    // Neighborhood filter
                    const matchesNeighborhood = selectedNeighborhoods.size === 0 || 
                        selectedNeighborhoods.has(location.neighborhood);
                    
                    // Tube line filter
                    const matchesTubeLine = selectedTubeLines.size === 0 || 
                        selectedTubeLines.has(location.tubeLine);
                    
                    return matchesSearch && matchesNeighborhood && matchesTubeLine;
                });
                
                createMarkers(filteredLocations);
            }
            
            // Initialize UI event handlers
            function initEventHandlers() {
                // Panel toggle buttons
                document.getElementById('toggleFilters').addEventListener('click', function() {
                    document.getElementById('filterPanel').classList.add('active');
                });
                
                document.getElementById('closePanel').addEventListener('click', function() {
                    document.getElementById('filterPanel').classList.remove('active');
                });
                
                // Locate nearby button
                document.getElementById('locateNearby').addEventListener('click', function() {
                    // Check if geolocation is available
                    if (navigator.geolocation) {
                        // Show loading state
                        this.innerHTML = '‚è≥';
                        
                        navigator.geolocation.getCurrentPosition(
                            function(position) {
                                // Get user coordinates
                                const userLat = position.coords.latitude;
                                const userLng = position.coords.longitude;
                                const userPosition = [userLat, userLng];
                                
                                // Add user marker
                                const userIcon = L.divIcon({
                                    className: 'user-location-marker',
                                    html: '<div style="background-color: #4285F4; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.3);"></div>',
                                    iconSize: [22, 22],
                                    iconAnchor: [11, 11]
                                });
                                
                                // Remove existing user marker if it exists
                                if (window.userMarker) {
                                    map.removeLayer(window.userMarker);
                                }
                                
                                // Add new user marker
                                window.userMarker = L.marker(userPosition, {icon: userIcon}).addTo(map);
                                
                                // Filter locations by distance (3km radius)
                                const nearbyLocations = locations.filter(location => {
                                    const tubeStop = location.tubeStop;
                                    if (!tubeStationCoordinates[tubeStop]) return false;
                                    
                                    const locCoords = tubeStationCoordinates[tubeStop];
                                    const distance = getDistance(userLat, userLng, locCoords[0], locCoords[1]);
                                    return distance <= 3; // 3km radius
                                });
                                
                                // Update filters to match nearby locations
                                document.querySelectorAll('.neighborhood-filter-checkbox').forEach(checkbox => {
                                    const neighborhood = checkbox.dataset.neighborhood;
                                    checkbox.checked = nearbyLocations.some(loc => loc.neighborhood === neighborhood);
                                });
                                
                                document.querySelectorAll('.tubeline-filter-checkbox').forEach(checkbox => {
                                    const tubeLine = checkbox.dataset.tubeLine;
                                    checkbox.checked = nearbyLocations.some(loc => loc.tubeLine === tubeLine);
                                });
                                
                                // Apply filters to update map
                                applyFilters();
                                
                                // Show results and center map
                                if (nearbyLocations.length > 0) {
                                    map.fitBounds([
                                        ...markers.getBounds().toBBoxString().split(',').map(Number),
                                        ...userPosition
                                    ], { padding: [50, 50] });
                                } else {
                                    // If no nearby locations, just zoom to user
                                    map.setView(userPosition, 14);
                                    alert("No locations found within 3km of your position.");
                                }
                                
                                // Reset button
                                document.getElementById('locateNearby').innerHTML = 'üìç';
                            },
                            function(error) {
                                // Handle errors
                                let errorMsg;
                                switch(error.code) {
                                    case error.PERMISSION_DENIED:
                                        errorMsg = "Location access denied. Please enable location services.";
                                        break;
                                    case error.POSITION_UNAVAILABLE:
                                        errorMsg = "Location information unavailable.";
                                        break;
                                    case error.TIMEOUT:
                                        errorMsg = "Location request timed out.";
                                        break;
                                    default:
                                        errorMsg = "An unknown error occurred.";
                                }
                                alert(errorMsg);
                                document.getElementById('locateNearby').innerHTML = 'üìç';
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 10000,
                                maximumAge: 0
                            }
                        );
                    } else {
                        alert("Geolocation is not supported by your browser.");
                    }
                });
                
                // Search field
                document.getElementById('search').addEventListener('input', applyFilters);
                
                // Completion filter
                document.getElementById('hideCompleted').addEventListener('change', applyFilters);
                
                // Reset button
                document.getElementById('resetCompletions').addEventListener('click', resetAllCompletions);
                
                // Neighborhood filter buttons
                document.getElementById('selectAllNeighborhoods').addEventListener('click', function() {
                    document.querySelectorAll('.neighborhood-filter-checkbox').forEach(checkbox => {
                        checkbox.checked = true;
                    });
                    applyFilters();
                });
                
                document.getElementById('clearAllNeighborhoods').addEventListener('click', function() {
                    document.querySelectorAll('.neighborhood-filter-checkbox').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    applyFilters();
                });
                
                // Tube line filter buttons
                document.getElementById('selectAllTubeLines').addEventListener('click', function() {
                    document.querySelectorAll('.tubeline-filter-checkbox').forEach(checkbox => {
                        checkbox.checked = true;
                    });
                    applyFilters();
                });
                
                document.getElementById('clearAllTubeLines').addEventListener('click', function() {
                    document.querySelectorAll('.tubeline-filter-checkbox').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    applyFilters();
                });
            }
            
            // Initialize the application
            function init() {
                // Generate filter elements
                generateNeighborhoodFilters();
                generateTubeLineFilters();
                
                // Set up event listeners
                initEventHandlers();
                
                // Create initial markers
                createMarkers();
            }
            
            // Start the application
            init();
        });
    </script>
</body>
</html>